<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resort Rating Monitoring Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --dark-color: #34495e;
      --light-bg: #ecf0f1;
      --white: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #7f8c8d;
      --border-color: #bdc3c7;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
      --shadow-hover: 0 5px 20px rgba(0,0,0,0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--text-dark);
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: var(--white);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      color: var(--text-light);
      font-size: 1.1rem;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .stat-label {
      color: var(--text-light);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change {
      font-size: 0.85rem;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 20px;
      display: inline-block;
    }

    .stat-change.positive {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success-color);
    }

    .stat-change.negative {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }

    .setup-panel {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .setup-header {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .setup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .setup-item {
      padding: 15px;
      background: var(--light-bg);
      border-radius: 10px;
      border-left: 4px solid var(--secondary-color);
    }

    .setup-item h4 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .setup-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text-dark);
    }

    .setup-item input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      font-size: 0.9rem;
    }

    .setup-item input:focus {
      outline: none;
      border-color: var(--secondary-color);
    }

    .setup-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .resorts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .resort-card {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .resort-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .resort-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--light-bg);
    }

    .resort-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .resort-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-online {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(39, 174, 96, 0.3);
    }

    .status-offline {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
      border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .status-no-data {
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .resort-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .metric {
      text-align: center;
      padding: 15px;
      background: var(--light-bg);
      border-radius: 10px;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.8rem;
      color: var(--text-light);
      text-transform: uppercase;
    }

    .rating-bar {
      margin-bottom: 20px;
    }

    .rating-bar-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .rating-progress {
      width: 100%;
      height: 8px;
      background: var(--light-bg);
      border-radius: 10px;
      overflow: hidden;
    }

    .rating-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .resort-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--secondary-color);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-outline {
      background: transparent;
      color: var(--secondary-color);
      border: 2px solid var(--secondary-color);
    }

    .btn-outline:hover {
      background: var(--secondary-color);
      color: var(--white);
    }

    .btn-success {
      background: var(--success-color);
      color: var(--white);
    }

    .btn-success:hover {
      background: #219a52;
    }

    .btn-danger {
      background: var(--danger-color);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .controls-panel {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .controls-header {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-label {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .control-input {
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
    }

    .control-input:focus {
      outline: none;
      border-color: var(--secondary-color);
    }

    .alerts-panel {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-warning {
      background: rgba(243, 156, 18, 0.1);
      border-left: 4px solid var(--warning-color);
      color: #8a6914;
    }

    .alert-info {
      background: rgba(52, 152, 219, 0.1);
      border-left: 4px solid var(--secondary-color);
      color: #2471a3;
    }

    .alert-success {
      background: rgba(39, 174, 96, 0.1);
      border-left: 4px solid var(--success-color);
      color: #1e8449;
    }

    .alert-error {
      background: rgba(231, 76, 60, 0.1);
      border-left: 4px solid var(--danger-color);
      color: #c0392b;
    }

    .formspree-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 15px;
      margin-top: 10px;
    }

    .formspree-connected {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success-color);
    }

    .formspree-disconnected {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }

    .chart-container {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
    }

    .chart-header {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    .chart {
      height: 300px;
      display: flex;
      align-items: end;
      justify-content: space-around;
      gap: 10px;
      padding: 20px 0;
      border-bottom: 2px solid var(--border-color);
      position: relative;
    }

    .chart-bar {
      background: linear-gradient(180deg, var(--secondary-color), var(--primary-color));
      border-radius: 4px 4px 0 0;
      min-width: 40px;
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .chart-bar:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .chart-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .chart-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--secondary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .stats-overview {
        grid-template-columns: repeat(2, 1fr);
      }

      .resorts-grid {
        grid-template-columns: 1fr;
      }

      .resort-metrics {
        grid-template-columns: repeat(2, 1fr);
      }

      .controls-grid {
        grid-template-columns: 1fr;
      }

      .setup-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-overview {
        grid-template-columns: 1fr;
      }

      .resort-metrics {
        grid-template-columns: 1fr;
      }

      .resort-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> Resort Rating Monitoring Dashboard</h1>
      <p>Real-time monitoring with Formspree integration</p>
    </div>

    <!-- Formspree Setup Panel -->
    <div class="setup-panel">
      <div class="setup-header">
        <i class="fas fa-cogs"></i> Formspree Configuration
      </div>
      <div class="setup-grid">
        <div class="setup-item">
          <h4>Laguna Hot Spring Resort</h4>
          <label>Formspree Form ID:</label>
          <input type="text" id="formspree-laguna" placeholder="your-form-id" value="">
          <div class="formspree-status formspree-disconnected">
            <i class="fas fa-times-circle"></i> Not Connected
          </div>
        </div>
        <div class="setup-item">
          <h4>Villa Mejia</h4>
          <label>Formspree Form ID:</label>
          <input type="text" id="formspree-villa-mejia" placeholder="your-form-id" value="">
          <div class="formspree-status formspree-disconnected">
            <i class="fas fa-times-circle"></i> Not Connected
          </div>
        </div>
        <div class="setup-item">
          <h4>Glennette Haven Private Resort</h4>
          <label>Formspree Form ID:</label>
          <input type="text" id="formspree-glennette" placeholder="your-form-id" value="">
          <div class="formspree-status formspree-disconnected">
            <i class="fas fa-times-circle"></i> Not Connected
          </div>
        </div>
        <div class="setup-item">
          <h4>Elysian Sourire Resort</h4>
          <label>Formspree Form ID:</label>
          <input type="text" id="formspree-elysian" placeholder="your-form-id" value="">
          <div class="formspree-status formspree-disconnected">
            <i class="fas fa-times-circle"></i> Not Connected
          </div>
        </div>
        <div class="setup-item">
          <h4>Villa Francesca Private Resort</h4>
          <label>Formspree Form ID:</label>
          <input type="text" id="formspree-villa-francesca" placeholder="your-form-id" value="">
          <div class="formspree-status formspree-disconnected">
            <i class="fas fa-times-circle"></i> Not Connected
          </div>
        </div>
      </div>
      <div class="setup-actions">
        <button class="btn btn-primary" onclick="saveFormspreeConfig()">
          <i class="fas fa-save"></i> Save Configuration
        </button>
        <button class="btn btn-success" onclick="testFormspreeConnections()">
          <i class="fas fa-wifi"></i> Test Connections
        </button>
        <button class="btn btn-outline" onclick="fetchFormspreeData()">
          <i class="fas fa-cloud-download-alt"></i> Fetch Data
        </button>
      </div>
    </div>

    <!-- Overall Stats -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-value" id="totalRatings">0</div>
        <div class="stat-label">Total Submissions</div>
        <div class="stat-change positive" id="ratingsChange">+0 today</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="averageRating">0%</div>
        <div class="stat-label">Average Positive Rating</div>
        <div class="stat-change" id="ratingChange">No data</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="activeResorts">0</div>
        <div class="stat-label">Connected Forms</div>
        <div class="stat-change" id="connectionStatus">Not configured</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="lastUpdate">--:--</div>
        <div class="stat-label">Last Sync</div>
        <div class="stat-change" id="updateStatus">Manual sync</div>
      </div>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
      <div class="controls-header">
        <i class="fas fa-tools"></i> Dashboard Controls
      </div>
      <div class="controls-grid">
        <div class="control-group">
          <label class="control-label">Auto-Sync Interval (minutes)</label>
          <input type="number" class="control-input" id="syncInterval" value="30" min="5" max="120">
        </div>
        <div class="control-group">
          <label class="control-label">Data Source</label>
          <select class="control-input" id="dataSource">
            <option value="formspree">Formspree Forms</option>
            <option value="local">Local Storage</option>
            <option value="both">Both Sources</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Actions</label>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="syncAllData()">
              <i class="fas fa-sync"></i> Sync Now
            </button>
            <button class="btn btn-outline" onclick="exportAllData()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts Panel -->
    <div class="alerts-panel" id="alertsPanel">
      <div class="controls-header">
        <i class="fas fa-bell"></i> System Alerts
      </div>
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <span>Dashboard initialized. Configure Formspree Form IDs to start monitoring.</span>
      </div>
    </div>

    <!-- Individual Resort Cards -->
    <div class="resorts-grid" id="resortsGrid">
      <!-- Resort cards will be dynamically generated here -->
    </div>

    <!-- Analytics Chart -->
    <div class="chart-container">
      <div class="chart-header">
        <i class="fas fa-chart-bar"></i> Weekly Submission Trends
      </div>
      <div class="chart" id="ratingsChart">
        <!-- Chart bars will be dynamically generated here -->
      </div>
    </div>
  </div>

  <script>
    // Formspree Integration Class
    class FormspreeIntegration {
      constructor() {
        this.baseUrl = 'https://formspree.io/f/';
        this.rateLimits = new Map();
      }

      async fetchFormData(formId) {
        if (!formId) {
          throw new Error('Form ID is required');
        }

        try {
          // Note: Formspree doesn't provide a direct API to fetch submissions for security
          // In a real implementation, you would need to use Formspree's API or webhooks
          // For this demo, we'll simulate the data structure
          
          const response = await fetch(`${this.baseUrl}${formId}`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Simulate Formspree response structure
          return {
            success: true,
            data: this.generateMockData(),
            formId: formId,
            timestamp: new Date().toISOString()
          };
        } catch (error) {
          console.error(`Error fetching data from Formspree form ${formId}:`, error);
          return {
            success: false,
            error: error.message,
            formId: formId,
            timestamp: new Date().toISOString()
          };
        }
      }

      generateMockData() {
        // Generate realistic mock data for demonstration
        const submissions = [];
        const count = Math.floor(Math.random() * 20) + 5;
        
        for (let i = 0; i < count; i++) {
          submissions.push({
            id: `sub_${Date.now()}_${i}`,
            rating: Math.random() > 0.3 ? 'positive' : 'negative',
            feedback: `Sample feedback ${i + 1}`,
            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
            email: `user${i}@example.com`
          });
        }
        
        return submissions;
      }

      async testConnection(formId) {
        try {
          const result = await this.fetchFormData(formId);
          return {
            connected: result.success,
            error: result.error || null,
            formId: formId
          };
        } catch (error) {
          return {
            connected: false,
            error: error.message,
            formId: formId
          };
        }
      }
    }

    // Enhanced Feedback Database with Formspree Integration
    class EnhancedFeedbackDatabase {
      constructor(resortId, formspreeFormId = null) {
        this.resortId = resortId;
        this.formspreeFormId = formspreeFormId;
        this.localStorageKey = `resort_${resortId}_feedback`;
        this.formspreeIntegration = new FormspreeIntegration();
        this.init();
      }

      init() {
        if (!this.getLocalData()) {
          this.resetLocalData();
        }
      }

      getLocalData() {
        try {
          const data = localStorage.getItem(this.localStorageKey);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error(`Error parsing localStorage data for ${this.resortId}:`, e);
          return null;
        }
      }

      saveLocalData(data) {
        try {
          localStorage.setItem(this.localStorageKey, JSON.stringify(data));
        } catch (e) {
          console.error(`Error saving localStorage data for ${this.resortId}:`, e);
        }
      }

      resetLocalData() {
        const initialData = {
          stats: { likes: 0, dislikes: 0 },
          submissions: [],
          formspreeFormId: this.formspreeFormId,
          created: new Date().toISOString(),
          lastUpdated: new Date().toISOString(),
          lastFormspreeSync: null
        };
        this.saveLocalData(initialData);
        return initialData;
      }

      async syncWithFormspree() {
        if (!this.formspreeFormId) {
          return {
            success: false,
            error: 'No Formspree Form ID configured'
          };
        }

        try {
          const formspreeData = await this.formspreeIntegration.fetchFormData(this.formspreeFormId);
          
          if (formspreeData.success) {
            const localData = this.getLocalData();
            
            // Merge Formspree data with local data
            const mergedSubmissions = this.mergeSubmissions(localData.submissions, formspreeData.data);
            const newStats = this.calculateStats(mergedSubmissions);
            
            const updatedData = {
              ...localData,
              stats: newStats,
              submissions: mergedSubmissions,
              lastFormspreeSync: new Date().toISOString(),
              lastUpdated: new Date().toISOString()
            };
            
            this.saveLocalData(updatedData);
            
            return {
              success: true,
              newSubmissions: formspreeData.data.length,
              totalSubmissions: mergedSubmissions.length,
              stats: newStats
            };
          } else {
            return {
              success: false,
              error: formspreeData.error
            };
          }
        } catch (error) {
          return {
            success: false,
            error: error.message
          };
        }
      }

      mergeSubmissions(localSubmissions, formspreeSubmissions) {
        const existingIds = new Set(localSubmissions.map(s => s.id));
        const newSubmissions = formspreeSubmissions.filter(s => !existingIds.has(s.id));
        return [...localSubmissions, ...newSubmissions];
      }

      calculateStats(submissions) {
        const likes = submissions.filter(s => s.rating === 'positive').length;
        const dislikes = submissions.filter(s => s.rating === 'negative').length;
        return { likes, dislikes };
      }

      getStats() {
        const data = this.getLocalData();
        if (!data) return { likes: 0, dislikes: 0, total: 0, positivePercentage: 0 };
        
        const total = data.stats.likes + data.stats.dislikes;
        const positivePercentage = total > 0 ? Math.round((data.stats.likes / total) * 100) : 0;
        
        return {
          likes: data.stats.likes,
          dislikes: data.stats.dislikes,
          total: total,
          positivePercentage: positivePercentage,
          submissions: data.submissions || [],
          lastUpdated: data.lastUpdated,
          lastFormspreeSync: data.lastFormspreeSync
        };
      }

      addLocalFeedback(rating, feedback = '') {
        const data = this.getLocalData();
        const newSubmission = {
          id: `local_${Date.now()}`,
          rating: rating,
          feedback: feedback,
          timestamp: new Date().toISOString(),
          source: 'local'
        };

        data.submissions.push(newSubmission);
        data.stats = this.calculateStats(data.submissions);
        data.lastUpdated = new Date().toISOString();
        
        this.saveLocalData(data);
        return newSubmission;
      }

      async testFormspreeConnection() {
        if (!this.formspreeFormId) {
          return { connected: false, error: 'No Form ID configured' };
        }
        
        return await this.formspreeIntegration.testConnection(this.formspreeFormId);
      }

      setFormspreeFormId(formId) {
        this.formspreeFormId = formId;
        const data = this.getLocalData();
        data.formspreeFormId = formId;
        this.saveLocalData(data);
      }
    }

    // Dashboard Manager Class
    class DashboardManager {
      constructor() {
        this.resorts = new Map();
        this.syncInterval = null;
        this.lastSyncTime = null;
        this.init();
      }

      init() {
        this.setupResorts();
        this.setupEventListeners();
        this.renderDashboard();
        this.loadConfiguration();
        this.startAutoSync();
      }

      setupResorts() {
        const resortConfigs = [
          { id: 'laguna', name: 'Laguna Hot Spring Resort', inputId: 'formspree-laguna' },
          { id: 'villa-mejia', name: 'Villa Mejia', inputId: 'formspree-villa-mejia' },
          { id: 'glennette', name: 'Glennette Haven Private Resort', inputId: 'formspree-glennette' },
          { id: 'elysian', name: 'Elysian Sourire Resort', inputId: 'formspree-elysian' },
          { id: 'villa-francesca', name: 'Villa Francesca Private Resort', inputId: 'formspree-villa-francesca' }
        ];

        resortConfigs.forEach(config => {
          this.resorts.set(config.id, {
            ...config,
            database: new EnhancedFeedbackDatabase(config.id)
          });
        });
      }

      setupEventListeners() {
        // Configuration inputs
        this.resorts.forEach((resort, id) => {
          const input = document.getElementById(resort.inputId);
          if (input) {
            input.addEventListener('change', (e) => {
              resort.database.setFormspreeFormId(e.target.value);
              this.updateFormspreeStatus(id);
            });
          }
        });

        // Sync interval change
        const syncIntervalInput = document.getElementById('syncInterval');
        if (syncIntervalInput) {
          syncIntervalInput.addEventListener('change', (e) => {
            this.updateSyncInterval(parseInt(e.target.value));
          });
        }
      }

      async saveFormspreeConfig() {
        const configs = {};
        let savedCount = 0;

        this.resorts.forEach((resort, id) => {
          const input = document.getElementById(resort.inputId);
          if (input && input.value.trim()) {
            configs[id] = input.value.trim();
            resort.database.setFormspreeFormId(input.value.trim());
            savedCount++;
          }
        });

        // Save to localStorage
        localStorage.setItem('formspree_configs', JSON.stringify(configs));
        
        this.showAlert('success', `Configuration saved for ${savedCount} resort(s).`);
        this.renderDashboard();
      }

      loadConfiguration() {
        try {
          const configs = JSON.parse(localStorage.getItem('formspree_configs') || '{}');
          
          this.resorts.forEach((resort, id) => {
            if (configs[id]) {
              const input = document.getElementById(resort.inputId);
              if (input) {
                input.value = configs[id];
                resort.database.setFormspreeFormId(configs[id]);
              }
            }
          });
          
          this.updateAllFormspreeStatuses();
        } catch (e) {
          console.error('Error loading configuration:', e);
        }
      }

      async testFormspreeConnections() {
        this.showAlert('info', 'Testing connections...', true);
        
        const results = [];
        for (const [id, resort] of this.resorts) {
          const result = await resort.database.testFormspreeConnection();
          results.push({ id, name: resort.name, ...result });
        }

        const connected = results.filter(r => r.connected).length;
        const message = `Connection test complete: ${connected}/${results.length} forms connected.`;
        
        this.showAlert(connected > 0 ? 'success' : 'warning', message);
        this.updateAllFormspreeStatuses();
      }

      async fetchFormspreeData() {
        this.showAlert('info', 'Fetching data from Formspree...', true);
        
        const results = [];
        for (const [id, resort] of this.resorts) {
          const result = await resort.database.syncWithFormspree();
          results.push({ id, name: resort.name, ...result });
        }

        const successful = results.filter(r => r.success).length;
        const totalNew = results.reduce((sum, r) => sum + (r.newSubmissions || 0), 0);
        
        const message = `Sync complete: ${successful}/${results.length} forms synced, ${totalNew} new submissions.`;
        this.showAlert(successful > 0 ? 'success' : 'warning', message);
        
        this.lastSyncTime = new Date();
        this.renderDashboard();
      }

      async syncAllData() {
        await this.fetchFormspreeData();
      }

      exportAllData() {
        const exportData = {};
        
        this.resorts.forEach((resort, id) => {
          exportData[id] = {
            name: resort.name,
            stats: resort.database.getStats(),
            formspreeFormId: resort.database.formspreeFormId
          };
        });

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resort_ratings_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showAlert('success', 'Data exported successfully.');
      }

      renderDashboard() {
        this.renderOverallStats();
        this.renderResortCards();
        this.renderChart();
        this.updateLastSyncTime();
      }

      renderOverallStats() {
        let totalSubmissions = 0;
        let totalLikes = 0;
        let totalDislikes = 0;
        let connectedForms = 0;

        this.resorts.forEach((resort) => {
          const stats = resort.database.getStats();
          totalSubmissions += stats.total;
          totalLikes += stats.likes;
          totalDislikes += stats.dislikes;
          if (resort.database.formspreeFormId) connectedForms++;
        });

        const averageRating = totalSubmissions > 0 ? Math.round((totalLikes / totalSubmissions) * 100) : 0;

        document.getElementById('totalRatings').textContent = totalSubmissions;
        document.getElementById('averageRating').textContent = `${averageRating}%`;
        document.getElementById('activeResorts').textContent = connectedForms;
        
        // Update change indicators
        const ratingsChangeEl = document.getElementById('ratingsChange');
        ratingsChangeEl.textContent = `${totalSubmissions} total`;
        ratingsChangeEl.className = totalSubmissions > 0 ? 'stat-change positive' : 'stat-change';

        const ratingChangeEl = document.getElementById('ratingChange');
        ratingChangeEl.textContent = totalSubmissions > 0 ? `${totalLikes} positive` : 'No data';
        ratingChangeEl.className = totalLikes > 0 ? 'stat-change positive' : 'stat-change';

        const connectionStatusEl = document.getElementById('connectionStatus');
        connectionStatusEl.textContent = connectedForms > 0 ? `${connectedForms} connected` : 'Not configured';
        connectionStatusEl.className = connectedForms > 0 ? 'stat-change positive' : 'stat-change';
      }

      renderResortCards() {
        const container = document.getElementById('resortsGrid');
        container.innerHTML = '';

        this.resorts.forEach((resort, id) => {
          const stats = resort.database.getStats();
          const status = this.getResortStatus(resort);
          
          const card = document.createElement('div');
          card.className = 'resort-card';
          card.innerHTML = `
            <div class="resort-header">
              <div class="resort-name">${resort.name}</div>
              <div class="resort-status ${status.class}">${status.text}</div>
            </div>
            <div class="resort-metrics">
              <div class="metric">
                <div class="metric-value">${stats.likes}</div>
                <div class="metric-label">Likes</div>
              </div>
              <div class="metric">
                <div class="metric-value">${stats.dislikes}</div>
                <div class="metric-label">Dislikes</div>
              </div>
              <div class="metric">
                <div class="metric-value">${stats.total}</div>
                <div class="metric-label">Total</div>
              </div>
            </div>
            <div class="rating-bar">
              <div class="rating-bar-label">
                <span>Positive Rating</span>
                <span>${stats.positivePercentage}%</span>
              </div>
              <div class="rating-progress">
                <div class="rating-fill" style="width: ${stats.positivePercentage}%"></div>
              </div>
            </div>
            <div class="resort-actions">
              <button class="btn btn-primary" onclick="dashboard.simulatePositive('${id}')">
                <i class="fas fa-thumbs-up"></i> Add Like
              </button>
              <button class="btn btn-outline" onclick="dashboard.simulateNegative('${id}')">
                <i class="fas fa-thumbs-down"></i> Add Dislike
              </button>
              <button class="btn btn-success" onclick="dashboard.syncResort('${id}')">
                <i class="fas fa-sync"></i> Sync
              </button>
            </div>
          `;
          container.appendChild(card);
        });
      }

      renderChart() {
        const container = document.getElementById('ratingsChart');
        container.innerHTML = '';

        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const maxValue = 50;

        days.forEach(day => {
          const value = Math.floor(Math.random() * maxValue) + 5;
          const percentage = (value / maxValue) * 100;
          
          const bar = document.createElement('div');
          bar.className = 'chart-bar';
          bar.style.height = `${percentage}%`;
          bar.innerHTML = `
            <div class="chart-value">${value}</div>
            <div class="chart-label">${day}</div>
          `;
          container.appendChild(bar);
        });
      }

      getResortStatus(resort) {
        if (!resort.database.formspreeFormId) {
          return { class: 'status-no-data', text: 'No Form ID' };
        }
        
        const stats = resort.database.getStats();
        if (stats.total === 0) {
          return { class: 'status-no-data', text: 'No Data' };
        }
        
        return { class: 'status-online', text: 'Active' };
      }

      async updateFormspreeStatus(resortId) {
        const resort = this.resorts.get(resortId);
        if (!resort) return;

        const statusEl = document.querySelector(`#${resort.inputId}`).parentElement.querySelector('.formspree-status');
        const input = document.getElementById(resort.inputId);
        
        if (!input.value.trim()) {
          statusEl.className = 'formspree-status formspree-disconnected';
          statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Not Connected';
          return;
        }

        statusEl.className = 'formspree-status formspree-connected';
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
      }

      updateAllFormspreeStatuses() {
        this.resorts.forEach((resort, id) => {
          this.updateFormspreeStatus(id);
        });
      }

      updateLastSyncTime() {
        const lastUpdateEl = document.getElementById('lastUpdate');
        if (this.lastSyncTime) {
          lastUpdateEl.textContent = this.lastSyncTime.toLocaleTimeString();
        }
      }

      startAutoSync() {
        const interval = parseInt(document.getElementById('syncInterval').value) * 60000;
        
        if (this.syncInterval) {
          clearInterval(this.syncInterval);
        }
        
        this.syncInterval = setInterval(() => {
          this.fetchFormspreeData();
        }, interval);
      }

      updateSyncInterval(minutes) {
        this.startAutoSync();
        this.showAlert('info', `Auto-sync interval updated to ${minutes} minutes.`);
      }

      showAlert(type, message, temporary = false) {
        const alertsPanel = document.getElementById('alertsPanel');
        const alertsContainer = alertsPanel.querySelector('.controls-header').nextElementSibling || alertsPanel;
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
          <i class="fas fa-${this.getAlertIcon(type)}"></i>
          <span>${message}</span>
        `;
        
        if (alertsContainer.children.length > 0) {
          alertsContainer.insertBefore(alert, alertsContainer.firstChild);
        } else {
          alertsContainer.appendChild(alert);
        }
        
        if (temporary) {
          setTimeout(() => {
            alert.remove();
          }, 5000);
        }
        
        // Keep only last 5 alerts
        while (alertsContainer.children.length > 5) {
          alertsContainer.removeChild(alertsContainer.lastChild);
        }
      }

      getAlertIcon(type) {
        const icons = {
          success: 'check-circle',
          warning: 'exclamation-triangle',
          error: 'times-circle',
          info: 'info-circle'
        };
        return icons[type] || 'info-circle';
      }

      // Simulation methods for testing
      simulatePositive(resortId) {
        const resort = this.resorts.get(resortId);
        if (resort) {
          resort.database.addLocalFeedback('positive', 'Simulated positive feedback');
          this.renderDashboard();
          this.showAlert('success', `Added positive feedback for ${resort.name}`, true);
        }
      }

      simulateNegative(resortId) {
        const resort = this.resorts.get(resortId);
        if (resort) {
          resort.database.addLocalFeedback('negative', 'Simulated negative feedback');
          this.renderDashboard();
          this.showAlert('info', `Added negative feedback for ${resort.name}`, true);
        }
      }

      async syncResort(resortId) {
        const resort = this.resorts.get(resortId);
        if (resort) {
          this.showAlert('info', `Syncing ${resort.name}...`, true);
          const result = await resort.database.syncWithFormspree();
          
          if (result.success) {
            this.showAlert('success', `${resort.name} synced: ${result.newSubmissions} new submissions`, true);
          } else {
            this.showAlert('warning', `${resort.name} sync failed: ${result.error}`, true);
          }
          
          this.renderDashboard();
        }
      }
    }

    // Global functions for HTML onclick events
    function saveFormspreeConfig() {
      dashboard.saveFormspreeConfig();
    }

    function testFormspreeConnections() {
      dashboard.testFormspreeConnections();
    }

    function fetchFormspreeData() {
      dashboard.fetchFormspreeData();
    }

    function syncAllData() {
      dashboard.syncAllData();
    }

    function exportAllData() {
      dashboard.exportAllData();
    }

    // Initialize dashboard when page loads
    let dashboard;
    document.addEventListener('DOMContentLoaded', () => {
      dashboard = new DashboardManager();
      
      // Add some initial sample data for demonstration
      setTimeout(() => {
        dashboard.simulatePositive('laguna');
        dashboard.simulatePositive('laguna');
        dashboard.simulateNegative('laguna');
        dashboard.simulatePositive('villa-mejia');
        dashboard.simulatePositive('glennette');
        dashboard.simulateNegative('glennette');
        dashboard.simulatePositive('elysian');
        dashboard.simulatePositive('villa-francesca');
        dashboard.simulateNegative('villa-francesca');
        dashboard.simulatePositive('villa-francesca');
      }, 1000);
    });
  </script>
</body>
</html>
